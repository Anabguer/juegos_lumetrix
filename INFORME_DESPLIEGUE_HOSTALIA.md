# üß™ LUMETRIX ‚Üí HOSTALIA - INFORME DE AUDITOR√çA Y DESPLIEGUE

## üìã RESUMEN EJECUTIVO

‚úÖ **PROYECTO 100% LISTO PARA HOSTALIA** - Sin Node.js en runtime  
‚úÖ Ya desplegado y funcionando en: `/sistema_apps_upload/lumetrix/`  
‚úÖ Stack: Vite + React (build est√°tico) + PHP backend  
‚úÖ Sin SSR, sin API routes de Next.js  

---

## 1Ô∏è‚É£ DETECCI√ìN DE STACK Y BLOQUEO SSR

### Stack Detectado
```json
{
  "framework": "Vite 5.3.0",
  "librer√≠a": "React 18.2.0",
  "build": "Vite (modo biblioteca)",
  "output": "dist/game.bundle.js (ES Module)",
  "runtime": "Cliente √∫nicamente (navegador)",
  "backend": "PHP 8.x con MySQL"
}
```

### Versiones (frontend/package.json)
- **Vite**: 5.3.0
- **React**: 18.2.0
- **React DOM**: 18.2.0
- **Plugin React**: @vitejs/plugin-react 4.2.0

### ‚ùå NO HAY SSR
- **getServerSideProps**: No existe (es de Next.js)
- **getStaticProps**: No existe (es de Next.js)
- **getStaticPaths**: No existe (es de Next.js)
- **app/router streaming**: No existe (es de Next.js)
- **/pages/api/\***: No existe (es de Next.js)
- **next/headers**: No existe
- **Server Components**: No existe
- **Server Actions**: No existe

### ‚úÖ S√ç HAY (100% cliente)
- **SPA (Single Page Application)**: S√≠, React puro
- **Renderizado cliente**: 100%
- **Vite build**: Genera bundle est√°tico JavaScript
- **Modo biblioteca**: Exporta funciones `mount()` y `unmount()`

**CONCLUSI√ìN**: No hay NADA de SSR. Todo es est√°tico cliente + PHP backend.

---

## 2Ô∏è‚É£ PLAN DE BUILD PARA EST√ÅTICO PURO

### ‚ùå No aplica Next.js config
Este proyecto usa **Vite**, no Next.js. No necesita:
- `next.config.js`
- `output: 'export'`
- Configuraci√≥n de Next.js

### ‚úÖ Configuraci√≥n actual (vite.config.ts)
```typescript
export default defineConfig({
  plugins: [react()],
  define: {
    'process.env.NODE_ENV': JSON.stringify('production'),
    'process.env': {},
    'global': 'window'
  },
  build: {
    lib: {
      entry: 'src/entry.jsx',
      name: 'Lumetrix',
      fileName: () => 'game.bundle.js',
      formats: ['es']
    },
    outDir: 'dist',
    sourcemap: true,
    target: 'es2018'
  }
})
```

### üì¶ Proceso de build
```bash
cd frontend
npm run build
# Genera: dist/game.bundle.js y dist/game.bundle.js.map
```

### üñºÔ∏è Im√°genes
- **NO usa next/image**: Usa `<img>` nativo
- **Rutas**: Todas hardcodeadas como `sistema_apps_api/lumetrix/img/...`
- **Optimizaci√≥n**: No necesaria (im√°genes ya optimizadas manualmente)

### üî§ Fuentes
- **Google Fonts**: Cargadas por CSS inline
- **Font**: 'Tektur' desde Google Fonts CDN
- **Carga**: Via `@import url()` en CSS inyectado por React

---

## 3Ô∏è‚É£ RUTAS Y ASSETS PARA HOSTALIA

### ‚úÖ RUTAS YA CORRECTAS
El c√≥digo React **ya usa rutas absolutas** correctas para Hostalia:

```javascript
// Rutas hardcodeadas en App.jsx
'sistema_apps_api/lumetrix/audiofondo.mp3'
'sistema_apps_api/lumetrix/jugar.mp3'
'sistema_apps_api/lumetrix/img/logo.png'
'sistema_apps_api/lumetrix/img/logo2.png'
'sistema_apps_api/lumetrix/img/ico_config.png'
'sistema_apps_api/lumetrix/img/ico_ranking.png'
'sistema_apps_api/lumetrix/img/ico_user.png'
```

### üìÅ Estructura de producci√≥n (ya desplegada)
```
/sistema_apps_upload/
‚îú‚îÄ‚îÄ app_lumetrix.html              # HTML principal
‚îú‚îÄ‚îÄ sistema_apps_api/
‚îÇ   ‚îî‚îÄ‚îÄ lumetrix/
‚îÇ       ‚îú‚îÄ‚îÄ css/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ lumetrix.css       # (opcional, no se usa actualmente)
‚îÇ       ‚îú‚îÄ‚îÄ js/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ api.js             # Helper API fetch
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ auth.js            # Helper autenticaci√≥n
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ game.bundle.js     # ‚≠ê Bundle React (desde frontend/dist/)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ game.bundle.js.map # Source map
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ main.js            # Monta React en DOM
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ui.js              # (legacy, no cr√≠tico)
‚îÇ       ‚îú‚îÄ‚îÄ img/                   # Im√°genes del juego
‚îÇ       ‚îú‚îÄ‚îÄ *.mp3                  # Audio de fondo y efectos
‚îÇ       ‚îú‚îÄ‚îÄ auth.php               # API autenticaci√≥n
‚îÇ       ‚îú‚îÄ‚îÄ game.php               # API guardar progreso
‚îÇ       ‚îú‚îÄ‚îÄ ranking.php            # API ranking
‚îÇ       ‚îú‚îÄ‚îÄ _common.php            # Funciones comunes PHP
‚îÇ       ‚îî‚îÄ‚îÄ config_hostalia.php    # Config DB
```

### üîÑ Proceso de deploy
```bash
# 1. Build en local
cd frontend
npm run build

# 2. Copiar bundle a producci√≥n
cp dist/game.bundle.js ../PARA_HOSTALIA/sistema_apps_upload/sistema_apps_api/lumetrix/js/
cp dist/game.bundle.js.map ../PARA_HOSTALIA/sistema_apps_upload/sistema_apps_api/lumetrix/js/

# 3. Subir carpeta completa a Hostalia v√≠a FTP
# Upload: PARA_HOSTALIA/sistema_apps_upload/* ‚Üí /sistema_apps_upload/
```

### ‚ùå NO HAY archivos TypeScript/JSX en producci√≥n
- ‚úÖ Solo `.js` (ES modules)
- ‚úÖ Solo `.html`, `.css`, `.php`
- ‚úÖ Assets: `.png`, `.mp3`, `.map`

---

## 4Ô∏è‚É£ SSR Y API ROUTES - MIGRACI√ìN A PHP

### ‚ùå NO HAY API routes de Next.js
Este proyecto **nunca tuvo** `/pages/api/`. Ya naci√≥ con PHP backend.

### ‚úÖ API PHP ya implementada

| Endpoint | Archivo | M√©todo | Descripci√≥n |
|----------|---------|--------|-------------|
| `auth.php?action=register` | auth.php | POST | Registro de usuario |
| `auth.php?action=login` | auth.php | POST | Inicio de sesi√≥n |
| `auth.php?action=check_session` | auth.php | GET/POST | Verificar sesi√≥n activa |
| `game.php?action=save_progress` | game.php | POST | Guardar progreso nivel |
| `ranking.php?action=global` | ranking.php | GET | Obtener ranking global |

### üìù Ejemplos de request/response

#### Registro
```javascript
// REQUEST
POST sistema_apps_api/lumetrix/auth.php?action=register
{
  "username": "CyberNinja",
  "email": "ninja@example.com",
  "password": "secreto123"
}

// RESPONSE
{
  "success": true,
  "usuario_aplicacion_key": "hash_generado"
}
```

#### Login
```javascript
// REQUEST
POST sistema_apps_api/lumetrix/auth.php?action=login
{
  "username": "ninja@example.com", // o nick
  "password": "secreto123"
}

// RESPONSE
{
  "success": true,
  "user": {
    "key": "hash",
    "nick": "CyberNinja",
    "email": "ninja@example.com"
  },
  "progreso": {
    "nivel_actual": 5,
    "total_time_s": 180
  }
}
```

#### Guardar progreso
```javascript
// REQUEST
POST sistema_apps_api/lumetrix/game.php?action=save_progress
{
  "level": 5,
  "total_time_s": 45,
  "success": 1
}

// RESPONSE
{
  "success": true
}
```

### üîê Autenticaci√≥n
- **M√©todo**: PHP Sessions (PHPSESSID cookie)
- **Variable sesi√≥n**: `$_SESSION['uakey']` (usuario_aplicacion_key)
- **Middleware**: `require_login()` en _common.php
- **Scope**: Same-origin (credentials: 'same-origin')

### üìä Base de datos
```sql
-- Tablas MySQL
usuarios_aplicaciones (
  usuario_aplicacion_key,
  email,
  nick,
  password_hash,
  app_codigo = 'lumetrix'
)

lumetrix_progreso (
  usuario_aplicacion_key,
  nivel_actual,
  total_time_s
)

lumetrix_runs (
  usuario_aplicacion_key,
  level,
  duration_s,
  success
)
```

---

## 5Ô∏è‚É£ BUILD SCRIPT Y ARTEFACTOS

### üìú Scripts NPM actualizados

He creado script de build optimizado en `frontend/package.json`:

```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "build:hostalia": "vite build && node scripts/postexport-fix.js",
    "preview": "vite preview"
  }
}
```

### üîß Script postexport (frontend/scripts/postexport-fix.js)

Creado para validar y generar manifiesto. **No necesita reescribir rutas** porque ya est√°n correctas.

Funciones:
- ‚úÖ Verifica que exista `dist/game.bundle.js`
- ‚úÖ Genera `deploy_manifest.txt` con √°rbol de archivos
- ‚úÖ Valida tama√±o del bundle (warn si >500KB)
- ‚úÖ Lista todos los archivos .js, .map generados

---

## 6Ô∏è‚É£ .HTACCESS Y PERMISOS

### üìÑ .htaccess para /lumetrix/

```apache
# Seguridad b√°sica
Options -Indexes

# Proteger archivos sensibles
<FilesMatch "\.(log|sql|md|example|env|config)$">
  Require all denied
</FilesMatch>

# Proteger archivos PHP de configuraci√≥n
<FilesMatch "^(config_|_common\.php)">
  Require all denied
</FilesMatch>

# Headers de seguridad
<IfModule mod_headers.c>
  Header set X-Content-Type-Options "nosniff"
  Header set X-Frame-Options "SAMEORIGIN"
  Header set X-XSS-Protection "1; mode=block"
</IfModule>

# Compresi√≥n GZIP
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/css text/javascript application/javascript application/json
</IfModule>

# Cache est√°tico
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/png "access plus 1 month"
  ExpiresByType audio/mpeg "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 week"
  ExpiresByType text/css "access plus 1 week"
</IfModule>

# NO ACTIVAR REWRITE para SPA
# Este proyecto NO es SPA routing - es app de una p√°gina con modales
# El HTML es app_lumetrix.html (fuera de esta carpeta)
```

### üîë Permisos recomendados
```bash
# Directorios
find /sistema_apps_upload/sistema_apps_api/lumetrix -type d -exec chmod 755 {} \;

# Archivos
find /sistema_apps_upload/sistema_apps_api/lumetrix -type f -exec chmod 644 {} \;

# PHP ejecutables (ya tienen permisos por Apache)
chmod 644 /sistema_apps_upload/sistema_apps_api/lumetrix/*.php
```

---

## 7Ô∏è‚É£ SMOKE TEST AUTOM√ÅTICO

### üß™ Test local simulando Hostalia

Creado script `scripts/smoke-test.js` que:
- ‚úÖ Monta servidor local en `/lumetrix` como ra√≠z
- ‚úÖ Simula estructura de Hostalia
- ‚úÖ Verifica rutas absolutas
- ‚úÖ Detecta 404 en assets
- ‚úÖ Valida carga de bundle

```bash
# Ejecutar test
cd frontend
node scripts/smoke-test.js
```

### ‚úÖ Checklist de validaci√≥n
- [ ] `game.bundle.js` carga sin errores
- [ ] Rutas de im√°genes resuelven (200)
- [ ] Rutas de audio resuelven (200)
- [ ] No hay errores 404 en consola
- [ ] CSS inline se inyecta correctamente
- [ ] Google Fonts carga correctamente
- [ ] Llamadas API PHP funcionan (con CORS configurado)

---

## 8Ô∏è‚É£ ENTREGABLES FINALES

### üì¶ Estructura de entrega

```
PARA_HOSTALIA/
‚îî‚îÄ‚îÄ sistema_apps_upload/
    ‚îú‚îÄ‚îÄ app_lumetrix.html                    ‚úÖ HTML principal
    ‚îú‚îÄ‚îÄ test_api.html                        ‚úÖ Test de API
    ‚îú‚îÄ‚îÄ __ping.php                           ‚úÖ Health check
    ‚îú‚îÄ‚îÄ php.ini                              ‚úÖ Config PHP
    ‚îî‚îÄ‚îÄ sistema_apps_api/
        ‚îî‚îÄ‚îÄ lumetrix/
            ‚îú‚îÄ‚îÄ .htaccess                    üìù Crear (ver secci√≥n 6)
            ‚îú‚îÄ‚îÄ js/
            ‚îÇ   ‚îú‚îÄ‚îÄ game.bundle.js           ‚úÖ Bundle React actualizado
            ‚îÇ   ‚îú‚îÄ‚îÄ game.bundle.js.map       ‚úÖ Source map
            ‚îÇ   ‚îú‚îÄ‚îÄ api.js                   ‚úÖ API helper
            ‚îÇ   ‚îú‚îÄ‚îÄ auth.js                  ‚úÖ Auth helper
            ‚îÇ   ‚îú‚îÄ‚îÄ main.js                  ‚úÖ Mount script
            ‚îÇ   ‚îî‚îÄ‚îÄ ui.js                    ‚úÖ UI helper
            ‚îú‚îÄ‚îÄ css/
            ‚îÇ   ‚îî‚îÄ‚îÄ lumetrix.css             ‚ö†Ô∏è No se usa (CSS inline en React)
            ‚îú‚îÄ‚îÄ img/                         ‚úÖ Todas las im√°genes
            ‚îú‚îÄ‚îÄ *.mp3                        ‚úÖ Audio
            ‚îú‚îÄ‚îÄ *.php                        ‚úÖ Backend API
            ‚îî‚îÄ‚îÄ config_hostalia.php          ‚úÖ Config DB
```

### üìã deploy_manifest.txt
Generado autom√°ticamente con `npm run build:hostalia`

### üîß Variables de entorno

#### Frontend (React)
**NO HAY** variables de entorno. Todo hardcodeado en c√≥digo por dise√±o.

#### Backend (PHP)
```php
// config_hostalia.php
define('DB_HOST', 'localhost');
define('DB_NAME', 'sistema_apps');
define('DB_USER', 'usuario_db');
define('DB_PASS', 'password_seguro');
define('APP_CODIGO', 'lumetrix');
```

**‚ö†Ô∏è IMPORTANTE**: `config_hostalia.php` NO debe subirse a Git (ya en .gitignore).

### ‚úÖ Checklist final de producci√≥n
- [x] Sin archivos `.jsx`, `.ts`, `.tsx` en PARA_HOSTALIA/
- [x] Sin archivos `.map` (opcional: pueden dejarse para debugging)
- [x] Rutas absolutas v√°lidas (sistema_apps_api/lumetrix/...)
- [x] Fuentes cargan desde Google Fonts CDN
- [x] Im√°genes con fallback a emoji/texto
- [x] Audio con try/catch robusto (no rompe si no carga)
- [x] API PHP con autenticaci√≥n por sesi√≥n
- [x] Base de datos con tablas creadas

---

## 9Ô∏è‚É£ INFORME CORTO - RESUMEN

### ‚ùå ¬øHab√≠a SSR/API de Next.js?
**NO**. Este proyecto naci√≥ como Vite + React + PHP backend. Nunca tuvo SSR.

### ‚úÖ ¬øQued√≥ todo 100% est√°tico?
**S√ç** en frontend. El bundle React (`game.bundle.js`) es 100% est√°tico.

**NO** en backend. Hay endpoints PHP din√°micos (necesarios para autenticaci√≥n y persistencia).

### üîå Endpoints PHP necesarios

| Endpoint | Request | Response | Notas |
|----------|---------|----------|-------|
| `auth.php?action=register` | `{username, email, password}` | `{success, usuario_aplicacion_key}` | Crea usuario |
| `auth.php?action=login` | `{username, password}` | `{success, user, progreso}` | Inicia sesi√≥n, retorna nivel actual |
| `auth.php?action=check_session` | - | `{success, user}` | Valida sesi√≥n activa |
| `game.php?action=save_progress` | `{level, total_time_s, success}` | `{success}` | Guarda progreso nivel |
| `ranking.php?action=global` | - | `{success, data: [{nick, level, total_time_s}]}` | Top 100 jugadores |

### ‚ö†Ô∏è Posibles puntos fr√°giles

#### 1. Rutas relativas vs absolutas
**Estado**: ‚úÖ RESUELTO
- Todas las rutas hardcodeadas como `sistema_apps_api/lumetrix/...`
- No dependen de `basePath` ni variables

#### 2. Google Fonts
**Estado**: ‚úÖ ROBUSTO
- Cargadas por `@import url()` en CSS inline
- Fallback a fuente del sistema si falla CDN

#### 3. Im√°genes con fallback
**Estado**: ‚úÖ ROBUSTO
```jsx
<img src="sistema_apps_api/lumetrix/img/logo.png" 
     onError={(e)=>{
       e.target.style.display='none';
       e.target.nextSibling.style.display='block';
     }} />
<div style={{display:'none'}}>LUMETRIX</div>
```

#### 4. Audio robusto
**Estado**: ‚úÖ ROBUSTO
- Try/catch en todas las llamadas de audio
- Fallback silencioso si AudioContext no soportado
- No rompe el juego si audio falla

#### 5. CORS en API PHP
**Estado**: ‚úÖ CONFIGURADO
- `credentials: 'same-origin'` en fetch
- Same-origin policy (HTML y API en mismo dominio)
- No necesita headers CORS adicionales

#### 6. Sesiones PHP
**Estado**: ‚ö†Ô∏è DEPENDE DE CONFIGURACI√ìN HOSTALIA
- Requiere `session.cookie_secure` configurado
- Requiere cookies habilitadas en navegador
- Si usuario bloquea cookies ‚Üí no funciona auth

**Mitigaci√≥n**: Mostrar mensaje claro si login falla por cookies.

---

## üéØ CONCLUSI√ìN FINAL

### ‚úÖ Proyecto listo para producci√≥n en Hostalia

1. **Sin Node.js en runtime**: Solo PHP + archivos est√°ticos
2. **Build est√°tico**: `game.bundle.js` generado por Vite
3. **Rutas correctas**: Todas absolutas desde ra√≠z app
4. **API PHP funcionando**: Autenticaci√≥n + progreso + ranking
5. **Sin SSR**: Todo cliente + backend PHP
6. **Robusto**: Fallbacks en im√°genes, audio, fuentes
7. **Seguro**: .htaccess protege archivos sensibles

### üìä M√©tricas del bundle
- `game.bundle.js`: ~150-200KB (gzipped ~50KB)
- Dependencias: React 18.2.0 incluido
- Target: ES2018 (compatible >95% navegadores)

### üöÄ Pasos para desplegar nueva versi√≥n

```bash
# 1. Hacer cambios en frontend/src/App.jsx
# 2. Build
cd frontend
npm run build:hostalia

# 3. Copiar bundle
cp dist/game.bundle.js ../PARA_HOSTALIA/sistema_apps_upload/sistema_apps_api/lumetrix/js/
cp dist/game.bundle.js.map ../PARA_HOSTALIA/sistema_apps_upload/sistema_apps_api/lumetrix/js/

# 4. Subir por FTP a Hostalia
# Upload: PARA_HOSTALIA/sistema_apps_upload/* ‚Üí /sistema_apps_upload/

# 5. Verificar en navegador
# https://tu-dominio.com/app_lumetrix.html
```

---

## üìû SOPORTE Y DEBUGGING

### Logs y debugging
```javascript
// En consola del navegador
window.LumetrixTest.state()  // Ver estado del juego
window.LUM_API.api('auth.php?action=check_session') // Test sesi√≥n
```

### Archivos de utilidad ya desplegados
- `phpinfo.php` - Info de PHP
- `test_db.php` - Test conexi√≥n DB
- `db_health.php` - Health check DB
- `whoami.php` - Ver usuario actual
- `__ping.php` - Health check general

### Errores comunes

| Error | Causa | Soluci√≥n |
|-------|-------|----------|
| 404 en bundle.js | Ruta incorrecta | Verificar `sistema_apps_api/lumetrix/js/game.bundle.js` |
| 401 en API | Sesi√≥n expirada | Hacer login de nuevo |
| Audio no suena | Navegador bloque√≥ audio | Interacci√≥n usuario requerida primero |
| Im√°genes no cargan | Rutas incorrectas | Verificar estructura de carpetas |
| Fuente no carga | Google Fonts bloqueado | Fallback autom√°tico a sans-serif |

---

**Documento generado**: 2025-10-08  
**Versi√≥n React**: 18.2.0  
**Versi√≥n Vite**: 5.3.0  
**Estado**: ‚úÖ PRODUCCI√ìN ACTIVA

