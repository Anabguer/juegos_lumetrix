# üéØ GU√çA OFICIAL DE DESPLIEGUE EN HOSTALIA
**Para proyectos de juegos y apps HTML/CSS/JS/PHP**

Esta gu√≠a unifica c√≥mo deben subirse, configurarse y vincularse las aplicaciones a la base de datos en Hostalia sin romper rutas ni duplicar carpetas.

---

## üîí Regla de Oro
**NO crear una carpeta llamada `sistema_apps_upload`.** Esa carpeta YA es la ra√≠z p√∫blica del servidor.

Cada juego debe subirse directamente dentro de esa ra√≠z: `/sistema_apps_upload/<nombre_del_juego>/`

---

## üìÅ Estructura Est√°ndar

```
/sistema_apps_upload/
‚îú‚îÄ‚îÄ memoflip/
‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ .htaccess
‚îú‚îÄ‚îÄ lumetrix/
‚îú‚îÄ‚îÄ adivina-hoy/
‚îî‚îÄ‚îÄ pueblito/
```

---

## ‚öôÔ∏è Rutas y Base HREF

### Todos los HTML deben tener en `<head>`:
```html
<base href="/sistema_apps_upload/<juego>/">
```

### Ejemplo de rutas correctas:
- **CSS** ‚Üí `/sistema_apps_upload/<juego>/css/styles.css`
- **JS** ‚Üí `/sistema_apps_upload/<juego>/js/app.js`
- **IMG** ‚Üí `/sistema_apps_upload/<juego>/assets/img/logo.png`
- **AUDIO** ‚Üí `/sistema_apps_upload/<juego>/assets/audio/intro.mp3`
- **API** ‚Üí `/sistema_apps_upload/<juego>/api/*.php`

---

## üß∞ BAT Universal de Deploy

El BAT debe hacer `cd /sistema_apps_upload` antes de crear la carpeta del juego.

```batch
@echo off
setlocal
set "HOST=82.194.68.83"
set "USER=sistema_apps_user"
set "PASS=GestionUploadSistemaApps!"
set "WINSCP=C:\Users\agl03\AppData\Local\Programs\WinSCP\WinSCP.com"
set "LOCAL=%~dp0sistema_apps_upload\<juego>"
set "REMOTE=/sistema_apps_upload/<juego>"

"%WINSCP%" /ini=nul /log:"%LOCAL%\deploy_<juego>.log" /command ^
 "open ftps://%USER%:%PASS%@%HOST%/ -explicit -certificate=*" ^
 "option batch on" ^
 "option confirm off" ^
 "lcd %LOCAL%" ^
 "cd /sistema_apps_upload" ^
 "mkdir <juego>" ^
 "cd <juego>" ^
 "synchronize remote -mirror -criteria=size" ^
 "exit"
```

---

## üóÑÔ∏è Estructura de Base de Datos

### 1. Insertar la app en la tabla `aplicaciones`:
```sql
INSERT INTO aplicaciones (app_codigo, nombre, descripcion, estado, creado_en)
VALUES ('memoflip', 'MemoFlip', 'Juego de memoria', 'ACTIVA', NOW())
ON DUPLICATE KEY UPDATE nombre=VALUES(nombre), descripcion=VALUES(descripcion);
```

### 2. Vincular usuarios con `usuarios_aplicaciones`:
Usar `usuario_aplicacion_key` (canon del email + '_' + juego).

### 3. Tabla Principal del Juego:
```sql
CREATE TABLE IF NOT EXISTS `{juego}_progreso` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `usuario_aplicacion_key` varchar(255) NOT NULL,
  `nivel_actual` int(11) DEFAULT 1,
  `total_puntos` int(11) DEFAULT 0,
  `total_tiempo` int(11) DEFAULT 0,
  `ultima_sincronizacion` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `usuario_aplicacion_key` (`usuario_aplicacion_key`),
  FOREIGN KEY (`usuario_aplicacion_key`) REFERENCES `usuarios_aplicaciones`(`usuario_aplicacion_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## üß© API admin_db.php

Archivo que crea/ajusta tablas del juego con FK a `usuarios_aplicaciones`, idempotente y ejecutable una sola vez.

```php
<?php
require_once '../config_hostalia.php';

$juego = 'memoflip'; // Cambiar por el nombre del juego

// Crear tablas del juego
$sql = "CREATE TABLE IF NOT EXISTS `{$juego}_progreso` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `usuario_aplicacion_key` varchar(255) NOT NULL,
  `nivel_actual` int(11) DEFAULT 1,
  `total_puntos` int(11) DEFAULT 0,
  `total_tiempo` int(11) DEFAULT 0,
  `ultima_sincronizacion` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `usuario_aplicacion_key` (`usuario_aplicacion_key`),
  FOREIGN KEY (`usuario_aplicacion_key`) REFERENCES `usuarios_aplicaciones`(`usuario_aplicacion_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;";

if ($conn->query($sql) === TRUE) {
    echo "‚úÖ Tabla {$juego}_progreso creada correctamente\n";
} else {
    echo "‚ùå Error creando tabla: " . $conn->error . "\n";
}
?>
```

---

## üîå API Endpoints Est√°ndar

### auth.php
```php
<?php
require_once '../config_hostalia.php';

$action = $_GET['action'] ?? '';

switch ($action) {
    case 'register':
        // Registro de usuario
        break;
    case 'login':
        // Login de usuario
        break;
    case 'check_session':
        // Verificar sesi√≥n activa
        break;
    case 'logout':
        // Cerrar sesi√≥n
        break;
}
?>
```

### game.php
```php
<?php
require_once '../config_hostalia.php';

$action = $_GET['action'] ?? '';

switch ($action) {
    case 'save_progress':
        // Guardar progreso del juego
        break;
    case 'get_progress':
        // Obtener progreso del usuario
        break;
    case 'get_ranking':
        // Obtener ranking global
        break;
}
?>
```

### Estructura de Respuesta
```php
// Respuesta exitosa
echo json_encode([
    'success' => true,
    'message' => 'Operaci√≥n exitosa',
    'data' => $data
]);

// Respuesta de error
echo json_encode([
    'success' => false,
    'message' => 'Error: ' . $error,
    'data' => null
]);
```

---

## üë§ Sistema de Usuarios y Sesiones - C√ìDIGO FUNCIONAL

### üîë Login Manual + Guardar Credenciales
```javascript
// En el componente Intro (handleLoginSuccess)
const handleLoginSuccess = async (email, password) => {
  setLoading(true);
  try {
    const result = await window.API.api('auth.php?action=login', {
      method: 'POST',
      body: JSON.stringify({ username: email, password })
    });
    
    if (result.success) {
      // ‚úÖ GUARDAR CREDENCIALES EN LOCALSTORAGE para auto-login
      try {
        localStorage.setItem('user_email', email);
        localStorage.setItem('user_token', btoa(password)); // Codificado en base64
        console.log('‚úÖ Credenciales guardadas para auto-login');
      } catch (e) {
        console.log('‚ö†Ô∏è No se pudieron guardar credenciales:', e);
      }
      
      setMessage('‚úÖ ¬°Bienvenido!');
      setTimeout(() => {
        window.location.reload(); // Recargar para actualizar estado
      }, 500);
    } else {
      setMessage('‚ùå Error: ' + (result.message || 'Credenciales incorrectas'));
    }
  } catch (e) {
    setMessage('‚ùå Error de conexi√≥n');
    console.error('Error en login:', e);
  } finally {
    setLoading(false);
  }
};
```

### üîÑ Auto-Login al Iniciar la App
```javascript
// En el useEffect principal del App (loadProgress)
useEffect(() => {
  const loadProgress = async () => {
    try {
      // ‚úÖ VERIFICAR SESI√ìN ACTIVA
      if (window.API && window.API.api) {
        const result = await window.API.api('auth.php?action=check_session');
        if (result && result.success) {
          setIsLoggedIn(true);
          setUserInfo(result.user);
          
          // Cargar progreso del servidor
          const progreso = await window.API.api('game.php?action=get_progress');
          if (progreso && progreso.success && progreso.data) {
            const serverProgress = {
              nivel_actual: progreso.data.nivel_actual || 1,
              total_time_s: progreso.data.total_time_s || 0,
              total_puntos: progreso.data.total_puntos || 0
            };
            
            // Actualizar estados con progreso del servidor
            setLevel(serverProgress.nivel_actual);
            setCurrentLevel(serverProgress.nivel_actual);
            setTotalTime(serverProgress.total_time_s);
            setTotalPuntos(serverProgress.total_puntos);
          }
        } else {
          // ‚ùå No hay sesi√≥n ‚Üí Intentar AUTO-LOGIN con credenciales guardadas
          const savedEmail = localStorage.getItem('user_email');
          const savedToken = localStorage.getItem('user_token');
          
          if (savedEmail && savedToken) {
            console.log('üîë Intentando auto-login...');
            try {
              const savedPassword = atob(savedToken);
              const loginResult = await window.API.api('auth.php?action=login', {
                method: 'POST',
                body: JSON.stringify({ username: savedEmail, password: savedPassword })
              });
              
              if (loginResult && loginResult.success) {
                console.log('‚úÖ Auto-login exitoso:', loginResult.user?.nick);
                setIsLoggedIn(true);
                setUserInfo(loginResult.user);
                
                // Cargar progreso del servidor despu√©s del auto-login
                const progreso = await window.API.api('game.php?action=get_progress');
                if (progreso && progreso.success && progreso.data) {
                  const serverProgress = {
                    nivel_actual: progreso.data.nivel_actual || 1,
                    total_time_s: progreso.data.total_time_s || 0,
                    total_puntos: progreso.data.total_puntos || 0
                  };
                  
                  setLevel(serverProgress.nivel_actual);
                  setCurrentLevel(serverProgress.nivel_actual);
                  setTotalTime(serverProgress.total_time_s);
                  setTotalPuntos(serverProgress.total_puntos);
                }
              } else {
                // Limpiar credenciales inv√°lidas
                localStorage.removeItem('user_email');
                localStorage.removeItem('user_token');
                setIsLoggedIn(false);
              }
            } catch (e) {
              console.log('‚ùå Error en auto-login:', e);
              setIsLoggedIn(false);
            }
          } else {
            setIsLoggedIn(false);
          }
        }
      }
    } catch (e) {
      console.error('Error cargando progreso:', e);
      setIsLoggedIn(false);
    }
  };
  loadProgress();
}, []);
```

### üìù UserModal - Pasar Email/Password
```javascript
// En el componente Intro (UserModal)
<UserModal
  isOpen={showLoginModal}
  onClose={() => setShowLoginModal(false)}
  onLoginSuccess={(email, password) => handleLoginSuccess(email, password)}
  title="Iniciar Sesi√≥n"
  mode="login"
/>

<UserModal
  isOpen={showRegisterModal}
  onClose={() => setShowRegisterModal(false)}
  onLoginSuccess={(email, password) => handleLoginSuccess(email, password)}
  title="Registrarse"
  mode="register"
/>
```

### üéÆ Actualizar UI seg√∫n Estado de Login
```javascript
// Actualizar UI seg√∫n estado de login
const updateUI = (isLoggedIn, userInfo) => {
  if (isLoggedIn) {
    document.getElementById('userMenu').innerHTML = `
      <span>Hola ${userInfo.nombre}</span>
      <button onclick="logout()">Desconectar</button>
    `;
  } else {
    document.getElementById('userMenu').innerHTML = `
      <button onclick="showRegister()">Registrarse</button>
      <button onclick="showLogin()">Entrar</button>
    `;
  }
};
```

---

## üì° Sistema H√≠brido Offline/Online

### Almacenamiento Local
```javascript
// Guardar progreso localmente
const saveLocalProgress = (data) => {
    localStorage.setItem('local_progress', JSON.stringify({
        ...data,
        timestamp: Date.now()
    }));
};

// Cargar progreso local
const getLocalProgress = () => {
    const saved = localStorage.getItem('local_progress');
    return saved ? JSON.parse(saved) : {
        nivel_actual: 1,
        total_puntos: 0,
        total_tiempo: 0
    };
};

// Marcar como pendiente de sincronizaci√≥n
const markPendingSync = () => {
    localStorage.setItem('pending_sync', 'true');
};
```

### Merge Inteligente
```javascript
// Al volver online, mergear local vs servidor
const mergeProgress = (local, server) => {
    return {
        nivel_actual: Math.max(local.nivel_actual, server.nivel_actual),
        total_puntos: Math.max(local.total_puntos, server.total_puntos),
        total_tiempo: Math.max(local.total_tiempo, server.total_tiempo)
    };
};

// Sincronizar cuando vuelve internet
const syncPendingChanges = async () => {
    if (navigator.onLine && localStorage.getItem('pending_sync')) {
        try {
            const localProgress = getLocalProgress();
            const result = await saveProgress(localProgress);
            if (result.success) {
                localStorage.removeItem('pending_sync');
                console.log('‚úÖ Progreso sincronizado');
            }
        } catch (error) {
            console.log('‚ùå Error sincronizando:', error);
        }
    }
};
```

### üîê Auto-Login Robusto

**IMPORTANTE:** El auto-login debe diferenciar entre errores de credenciales y errores de red.

```javascript
// ‚ùå MAL: Borrar credenciales siempre que falla
if (!loginResult.success) {
    localStorage.removeItem('user_email');
    localStorage.removeItem('user_token');
}

// ‚úÖ BIEN: Solo borrar si son credenciales inv√°lidas
if (!loginResult.success) {
    const errorMsg = loginResult?.message || '';
    const isCredentialError = errorMsg.includes('inv√°lidas') || 
                             errorMsg.includes('incorrectas') || 
                             errorMsg.includes('no encontrado');
    
    if (isCredentialError) {
        console.log('‚ö†Ô∏è Credenciales inv√°lidas, limpiando...');
        localStorage.removeItem('user_email');
        localStorage.removeItem('user_token');
    } else {
        console.log('‚ö†Ô∏è Error temporal (red/servidor), manteniendo credenciales');
    }
}

// ‚úÖ MEJOR: Tampoco borrar en caso de excepciones de red
try {
    const loginResult = await api('auth.php?action=login', {...});
    // ... manejo del resultado
} catch (e) {
    console.log('‚ùå Error de red, manteniendo credenciales para reintentar');
    // NO borrar credenciales aqu√≠
}
```

### Auto-retry con Re-autenticaci√≥n

```javascript
// üî• Reintentar auto-login Y sincronizaci√≥n cuando vuelve internet
const checkAndRetrySync = useCallback(async () => {
    if (!navigator.onLine) return;
    
    // 1Ô∏è‚É£ Si NO est√° logueado pero HAY credenciales ‚Üí Reintentar auto-login
    if (!isLoggedIn) {
        const savedEmail = localStorage.getItem('user_email');
        const savedToken = localStorage.getItem('user_token');
        
        if (savedEmail && savedToken) {
            console.log('üîÑ Reintentando auto-login...');
            try {
                const savedPassword = atob(savedToken);
                const loginResult = await api('auth.php?action=login', {
                    method: 'POST',
                    body: JSON.stringify({ username: savedEmail, password: savedPassword })
                });
                
                if (loginResult && loginResult.success) {
                    console.log('‚úÖ Auto-login exitoso!');
                    setIsLoggedIn(true);
                    setUserInfo(loginResult.user);
                    
                    // Mergear progreso local + servidor
                    const localProgress = getLocalProgress();
                    const serverProgress = await getServerProgress();
                    const merged = mergeProgress(localProgress, serverProgress);
                    
                    // Aplicar y sincronizar
                    applyProgress(merged);
                    if (merged > serverProgress) {
                        await syncToServer(merged);
                    }
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Error al reintentar, volveremos a intentar');
            }
        }
    }
    
    // 2Ô∏è‚É£ Si hay progreso pendiente de sincronizar ‚Üí Sincronizar
    if (getPendingSync() && isLoggedIn) {
        await syncPendingChanges();
    }
}, [isLoggedIn]);

// Listeners de conectividad
useEffect(() => {
    window.addEventListener('online', checkAndRetrySync);
    const interval = setInterval(checkAndRetrySync, 30000); // Cada 30s
    
    return () => {
        window.removeEventListener('online', checkAndRetrySync);
        clearInterval(interval);
    };
}, [checkAndRetrySync]);
```

### üß™ Testing del Auto-Login Robusto

**Escenario 1: Sin internet al abrir**
1. ‚úÖ Login manual con internet
2. ‚ùå Cerrar app, quitar internet (modo avi√≥n)
3. üîÑ Abrir app
4. **Resultado esperado:** App funciona offline, credenciales guardadas
5. ‚úÖ Conectar internet ‚Üí Auto-login autom√°tico + sincronizaci√≥n

**Escenario 2: Servidor ca√≠do**
1. ‚úÖ Login manual
2. ‚ùå Servidor ca√≠do o error 500
3. üîÑ Abrir app
4. **Resultado esperado:** Credenciales NO borradas, reintento cada 30s
5. ‚úÖ Servidor vuelve ‚Üí Auto-login exitoso

**Escenario 3: Credenciales incorrectas**
1. ‚úÖ Login manual
2. ‚ùå Usuario cambia contrase√±a en otro dispositivo
3. üîÑ Abrir app
4. **Resultado esperado:** Auto-login falla con "credenciales inv√°lidas"
5. ‚úÖ Credenciales borradas, se muestra pantalla de login

---

## üîê .htaccess Base

```apache
Options -Indexes

# Bloquear archivos sensibles
<FilesMatch "\.(log|sql|md|env|ini|bat|sh|example)$">
  Require all denied
</FilesMatch>

# Compresi√≥n
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/css application/javascript application/json image/svg+xml
</IfModule>

# Cache
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType text/css "access plus 7 days"
  ExpiresByType application/javascript "access plus 7 days"
  ExpiresByType image/png "access plus 30 days"
  ExpiresByType image/jpeg "access plus 30 days"
  ExpiresByType audio/mpeg "access plus 30 days"
</IfModule>

# CORS para desarrollo
<IfModule mod_headers.c>
  Header always set Access-Control-Allow-Origin "*"
  Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
  Header always set Access-Control-Allow-Headers "Content-Type"
</IfModule>
```

---

## üéµ Audio en APK (Capacitor)

### Configuraci√≥n de Audio
```javascript
// Audio que NO se corta al minimizar la app
const initAudio = () => {
    const audio = new Audio('assets/audio/background.mp3');
    audio.loop = true;
    audio.volume = 0.5;
    audio.preload = 'auto';
    
    // NO agregar listeners de visibilitychange
    // NO agregar listeners de appStateChange
    // NO reiniciar manualmente en 'ended'
    
    return audio;
};
```

### Wrapper API para Capacitor
```javascript
// Detectar si estamos en Capacitor
const isCapacitor = () => {
    return window.Capacitor !== undefined || window.location.protocol === 'capacitor:';
};

// Wrapper API que usa CapacitorHttp en APK, fetch en web
const api = async (endpoint, options = {}) => {
    const url = isCapacitor() ? 
        `https://colisan.com/sistema_apps_upload/${juego}/${endpoint}` : 
        endpoint;
    
    if (isCapacitor() && window.Capacitor?.Plugins?.CapacitorHttp) {
        const { CapacitorHttp } = window.Capacitor.Plugins;
        const response = await CapacitorHttp.request({
            url: url,
            method: options.method || 'GET',
            headers: { 'Content-Type': 'application/json', ...options.headers },
            data: options.body ? JSON.parse(options.body) : undefined
        });
        return response.data;
    } else {
        const response = await fetch(url, {
            method: options.method || 'GET',
            headers: { 'Content-Type': 'application/json', ...options.headers },
            body: options.body
        });
        return await response.json();
    }
};
```

---

## üîç Herramientas de Debugging

### Debug del Auto-Login en Consola

A√±adir a tu c√≥digo una utilidad de debugging:

```javascript
useEffect(() => {
  // üîç DEBUG: Funci√≥n para ver estado de auto-login
  window.LUM_DEBUG = {
    checkAuth: () => {
      const email = localStorage.getItem('lum_user_email');
      const token = localStorage.getItem('lum_user_token');
      console.log('üìä Estado de Autenticaci√≥n:', {
        email: email || '‚ùå No guardado',
        token: token ? '‚úÖ Guardado' : '‚ùå No guardado',
        password: token ? atob(token) : '‚ùå No disponible',
        isLoggedIn: isLoggedIn,
        userInfo: userInfo
      });
      return { email, token: token ? atob(token) : null, isLoggedIn, userInfo };
    },
    clearAuth: () => {
      localStorage.removeItem('lum_user_email');
      localStorage.removeItem('lum_user_token');
      console.log('‚úÖ Credenciales eliminadas');
    }
  };
}, [isLoggedIn, userInfo]);
```

### Uso en consola del navegador:

```javascript
// Ver estado de autenticaci√≥n
LUM_DEBUG.checkAuth()

// Limpiar credenciales manualmente (para testing)
LUM_DEBUG.clearAuth()
```

---

## ‚úÖ Checklist Final

### Despliegue
- ‚òë No crear `sistema_apps_upload`
- ‚òë Crear solo `/sistema_apps_upload/<juego>/`
- ‚òë Base href correcto en todos los HTML
- ‚òë Rutas relativas al base
- ‚òë Ejecutar BAT de deploy

### Base de Datos
- ‚òë Insertar registro en `aplicaciones`
- ‚òë Ejecutar `api/admin_db.php`
- ‚òë Verificar tablas creadas con FK correctas

### Funcionalidad
- ‚òë Registro de usuarios funciona
- ‚òë Login manual funciona
- ‚òë Auto-login con localStorage funciona
- ‚òë Auto-login NO borra credenciales en errores de red
- ‚òë Auto-retry funciona cuando vuelve internet
- ‚òë Menu de usuario se actualiza correctamente
- ‚òë Progreso se guarda localmente
- ‚òë Sincronizaci√≥n offline/online funciona
- ‚òë Merge inteligente funciona (local vs servidor)
- ‚òë Audio funciona en web y APK

### Testing
- ‚òë Verificar 200 OK y sin 404
- ‚òë Test offline/online OK
- ‚òë Test auto-login OK
- ‚òë Test auto-login con servidor ca√≠do OK
- ‚òë Test auto-login con credenciales inv√°lidas OK
- ‚òë Test auto-retry cuando vuelve internet OK
- ‚òë Test merge inteligente (jugar offline ‚Üí online) OK
- ‚òë Test audio sin cortes OK

---

## üìß SISTEMA DE VERIFICACI√ìN POR EMAIL

### üìã **Descripci√≥n**

Sistema completo de verificaci√≥n de cuentas por email con c√≥digo de 6 d√≠gitos que expira en 24 horas.  
**Basado en el sistema funcional de MemoFlip.**

---

### üóÑÔ∏è **1. Cambios en la Base de Datos**

#### **Archivo:** `lumetrix/agregar_verificacion_email.sql`

```sql
-- Agregar columnas para verificaci√≥n por email
ALTER TABLE usuarios_aplicaciones 
ADD COLUMN IF NOT EXISTS email_verificado TINYINT(1) DEFAULT 0,
ADD COLUMN IF NOT EXISTS codigo_verificacion VARCHAR(10) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS tiempo_verificacion TIMESTAMP NULL DEFAULT NULL,
ADD COLUMN IF NOT EXISTS intentos_verificacion INT DEFAULT 0;

-- Marcar usuarios existentes como verificados (migraci√≥n)
UPDATE usuarios_aplicaciones 
SET email_verificado = 1 
WHERE email_verificado = 0 AND fecha_registro < NOW();
```

#### **Ejecutar en Hostalia:**
1. Acceder a phpMyAdmin
2. Seleccionar la base de datos del proyecto
3. Ejecutar el script SQL
4. Verificar que las 4 columnas se crearon correctamente

---

### üìß **2. Sistema de Env√≠o de Emails**

#### **Archivo:** `lumetrix/enviar_email.php`

**Funciones disponibles:**

##### `enviarEmailVerificacion($email, $nombre, $codigo)`
- Env√≠a email HTML con dise√±o Lumetrix (gradientes ne√≥n)
- Template con c√≥digo destacado en grande
- Advertencia de expiraci√≥n de 24 horas
- Retorna `true` si el email se envi√≥ correctamente

##### `generarCodigoVerificacion()`
- Genera c√≥digo aleatorio de 6 d√≠gitos num√©ricos
- Formato: `123456`

##### `codigoEsValido($tiempo_verificacion, $horas_validez = 24)`
- Verifica si un c√≥digo ha expirado
- Por defecto: 24 horas de validez

##### `limpiarCodigosExpirados($pdo)`
- Limpia c√≥digos expirados de la base de datos
- Ejecutar peri√≥dicamente con cron (opcional)

---

### üîê **3. API de Autenticaci√≥n Actualizada**

#### **Archivo:** `lumetrix/auth_con_verificacion.php`

**Este archivo reemplaza a `auth.php` cuando quieras activar la verificaci√≥n.**

#### **Endpoints nuevos:**

##### `POST auth.php?action=register`
**Cambios:** Ahora genera c√≥digo y env√≠a email

**Request:**
```json
{
  "nombre": "Anabel",
  "username": "anabel",
  "email": "anabel@ejemplo.com",
  "password": "mipassword"
}
```

**Response (√©xito):**
```json
{
  "success": true,
  "message": "Registro exitoso. Revisa tu email para el c√≥digo de verificaci√≥n.",
  "requires_verification": true,
  "email_sent": true,
  "user_key": "anabel@ejemplo.com_lumetrix"
}
```

**Response (desarrollo, sin email configurado):**
```json
{
  "success": true,
  "requires_verification": true,
  "email_sent": false,
  "codigo_dev": "123456"
}
```

---

##### `POST auth.php?action=verify_code`
**Verifica el c√≥digo introducido por el usuario**

**Request:**
```json
{
  "email": "anabel@ejemplo.com",
  "codigo": "123456"
}
```

**Response (√©xito):**
```json
{
  "success": true,
  "message": "¬°Cuenta verificada correctamente!",
  "verified": true,
  "user_key": "anabel@ejemplo.com_lumetrix"
}
```

**Response (c√≥digo incorrecto):**
```json
{
  "success": false,
  "error": "C√≥digo incorrecto"
}
```

**Response (c√≥digo expirado):**
```json
{
  "success": false,
  "error": "C√≥digo expirado. Solicita uno nuevo."
}
```

---

##### `POST auth.php?action=resend_code`
**Reenv√≠a un nuevo c√≥digo al usuario**

**Request:**
```json
{
  "email": "anabel@ejemplo.com"
}
```

**Response:**
```json
{
  "success": true,
  "message": "C√≥digo reenviado a tu email",
  "email_sent": true
}
```

---

##### `POST auth.php?action=login`
**MODIFICADO:** Ahora requiere email verificado

**Request:** (sin cambios)
```json
{
  "username": "anabel@ejemplo.com",
  "password": "mipassword"
}
```

**Response (email no verificado):**
```json
{
  "success": false,
  "message": "Debes verificar tu email antes de iniciar sesi√≥n",
  "requires_verification": true,
  "email": "anabel@ejemplo.com"
}
```

**Response (login exitoso):**
```json
{
  "success": true,
  "user": {
    "key": "anabel@ejemplo.com_lumetrix",
    "nick": "anabel",
    "email": "anabel@ejemplo.com",
    "fecha_registro": "2025-01-15 10:30:00"
  },
  "progreso": {
    "nivel_actual": 5,
    "total_time_s": 1200
  }
}
```

---

### üîÑ **4. Flujo Completo de Registro**

```
1. Usuario llena formulario de registro en la app
   ‚Üì
2. App env√≠a POST a auth.php?action=register
   ‚Üì
3. Servidor genera c√≥digo de 6 d√≠gitos (ej: 834521)
   ‚Üì
4. C√≥digo se guarda en BD (usuarios_aplicaciones.codigo_verificacion)
   ‚Üì
5. Se env√≠a email con c√≥digo (subject: "üéÆ Verifica tu cuenta de Lumetrix")
   ‚Üì
6. Usuario recibe email y ve c√≥digo en grande
   ‚Üì
7. Usuario introduce c√≥digo en la app
   ‚Üì
8. App env√≠a POST a auth.php?action=verify_code
   ‚Üì
9. Servidor valida:
   ‚úÖ C√≥digo correcto
   ‚úÖ No expirado (< 24h)
   ‚Üì
10. Usuario activado:
    - activo = 1
    - email_verificado = 1
    - codigo_verificacion = NULL
   ‚Üì
11. ¬°Usuario puede hacer login!
```

---

### üìä **5. Estados de Usuario**

| Estado | `activo` | `email_verificado` | ¬øPuede login? | Notas |
|--------|----------|-------------------|---------------|-------|
| Reci√©n registrado | 0 | 0 | ‚ùå No | Esperando verificaci√≥n |
| Email verificado | 1 | 1 | ‚úÖ S√≠ | Cuenta activada |
| Usuario antiguo* | 1 | 1 | ‚úÖ S√≠ | Auto-verificado al ejecutar SQL |

*Los usuarios existentes antes de activar este sistema se marcan autom√°ticamente como verificados.

---

### üöÄ **6. Activar Verificaci√≥n en Producci√≥n**

#### **Paso 1: Ejecutar SQL**
```bash
# En phpMyAdmin de Hostalia
1. Seleccionar base de datos
2. Pesta√±a "SQL"
3. Pegar contenido de: agregar_verificacion_email.sql
4. Click "Continuar"
5. Verificar mensaje: "4 columnas agregadas"
```

#### **Paso 2: Subir archivos PHP**
```bash
# Subir a Hostalia v√≠a FTP/WinSCP
/sistema_apps_upload/lumetrix/
‚îú‚îÄ‚îÄ enviar_email.php (NUEVO)
‚îî‚îÄ‚îÄ auth.php (REEMPLAZAR con auth_con_verificacion.php)
```

‚ö†Ô∏è **IMPORTANTE:** Hacer backup del `auth.php` original antes de reemplazarlo.

#### **Paso 3: Verificar configuraci√≥n de email**
- Servidor SMTP debe estar configurado en Hostalia
- Email `noreply@colisan.com` debe existir
- Verificar que no se bloqueen emails como spam

#### **Paso 4: Probar en desarrollo**
```bash
# Registro de prueba
curl -X POST https://colisan.com/sistema_apps_upload/lumetrix/auth.php \
  -H "Content-Type: application/json" \
  -d '{
    "action": "register",
    "nombre": "Test",
    "username": "test",
    "email": "test@ejemplo.com",
    "password": "test123"
  }'

# Si email_sent: false ‚Üí Usar codigo_dev de la respuesta
# Si email_sent: true ‚Üí Revisar bandeja de entrada
```

---

### ‚öôÔ∏è **7. Configuraci√≥n Avanzada**

#### **Cambiar tiempo de expiraci√≥n:**
```php
// En enviar_email.php, l√≠nea ~67
function codigoEsValido($tiempo_verificacion, $horas_validez = 24) {
    // Cambiar 24 por las horas deseadas
    // Ejemplos: 12 horas, 48 horas, etc.
}
```

#### **Cambiar longitud del c√≥digo:**
```php
// En enviar_email.php, l√≠nea ~58
function generarCodigoVerificacion() {
    // 6 d√≠gitos (actual):
    return str_pad(rand(100000, 999999), 6, '0', STR_PAD_LEFT);
    
    // 4 d√≠gitos:
    // return str_pad(rand(1000, 9999), 4, '0', STR_PAD_LEFT);
}
```

#### **Personalizar plantilla de email:**
Editar `enviar_email.php` l√≠neas 13-65 para cambiar:
- Colores del email
- Texto del mensaje
- Logo/header
- Footer

---

### üîç **8. Troubleshooting**

#### **Email no se env√≠a:**
```bash
# Verificar logs de PHP
tail -f /ruta/a/php_error.log

# Verificar que mail() funcione
<?php
$test = mail('tu@email.com', 'Test', 'Prueba');
echo $test ? 'OK' : 'FAIL';
?>
```

**Soluciones:**
- Verificar configuraci√≥n SMTP en Hostalia
- Revisar carpeta de spam
- Usar servicio externo (SendGrid, Mailgun, etc.)

#### **C√≥digo no v√°lido:**
- Verificar que no hayan pasado 24 horas
- C√≥digo es case-sensitive (solo n√∫meros)
- Revisar campo `codigo_verificacion` en BD

#### **Usuario no puede hacer login:**
```sql
-- Verificar estado del usuario
SELECT nick, email, activo, email_verificado, codigo_verificacion, tiempo_verificacion
FROM usuarios_aplicaciones
WHERE email = 'usuario@ejemplo.com';

-- Si necesitas activar manualmente:
UPDATE usuarios_aplicaciones
SET activo = 1, email_verificado = 1
WHERE email = 'usuario@ejemplo.com';
```

---

### üìù **9. Notas Importantes**

‚ö†Ô∏è **Compatibilidad hacia atr√°s:**
- Usuarios existentes se marcan autom√°ticamente como verificados
- No afecta a usuarios ya registrados
- Sistema opcional: puedes activarlo cuando quieras

‚ö†Ô∏è **Seguridad:**
- C√≥digos v√°lidos solo 24 horas
- Se registran intentos fallidos
- Posible mejora: limitar intentos (ej: 5 m√°ximo)

‚ö†Ô∏è **Modo desarrollo:**
- Si email falla, c√≥digo aparece en respuesta JSON
- Solo para facilitar testing local
- En producci√≥n con SMTP configurado no aparecer√°

---

### ‚úÖ **10. Checklist de Implementaci√≥n**

- [ ] Ejecutar SQL en Hostalia (agregar columnas)
- [ ] Verificar que columnas se crearon correctamente
- [ ] Hacer backup de `auth.php` original
- [ ] Subir `enviar_email.php` a Hostalia
- [ ] Reemplazar `auth.php` con `auth_con_verificacion.php`
- [ ] Verificar configuraci√≥n SMTP
- [ ] Probar registro ‚Üí ¬øLlega email?
- [ ] Probar c√≥digo correcto ‚Üí ¬øActiva cuenta?
- [ ] Probar c√≥digo incorrecto ‚Üí ¬øMuestra error?
- [ ] Probar c√≥digo expirado (cambiar fecha en BD para testing)
- [ ] Probar reenv√≠o de c√≥digo ‚Üí ¬øLlega nuevo email?
- [ ] Probar login sin verificar ‚Üí ¬øMuestra error?
- [ ] Probar login con email verificado ‚Üí ¬øPermite acceso?

---

### üé® **11. Template de Email (Vista Previa)**

El email que recibe el usuario tiene:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üéÆ LUMETRIX                        ‚îÇ
‚îÇ  Anti-Simon Challenge               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                     ‚îÇ
‚îÇ  ¬°Hola, Anabel!                     ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Gracias por registrarte en         ‚îÇ
‚îÇ  Lumetrix. Para activar tu cuenta,  ‚îÇ
‚îÇ  introduce el siguiente c√≥digo:     ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ TU C√ìDIGO DE VERIFICACI√ìN   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ      8 3 4 5 2 1           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                             ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚è±Ô∏è Expira en 24 horas              ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Si no solicitaste este c√≥digo,     ‚îÇ
‚îÇ  ignora este email.                 ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ¬© 2025 Lumetrix                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Colores:** Gradiente verde ne√≥n (#39ff14) y cian (#00e5ff) - Estilo Lumetrix

---

## üéØ Conclusi√≥n

Sube solo la carpeta del juego. Las rutas deben apuntar a `/sistema_apps_upload/<juego>/`. Las tablas se enlazan con `usuarios_aplicaciones` mediante `usuario_aplicacion_key`. 

**Con este c√≥digo funcional de Lumetrix, todos los proyectos se desplegar√°n sin duplicar carpetas ni romper rutas, con funcionalidad completa de usuarios, sesiones, offline/online, audio y verificaci√≥n por email.**

**¬°Listo para usar en cualquier proyecto nuevo!** üöÄ

---

# üìß SISTEMA DE VERIFICACI√ìN POR EMAIL - LUMETRIX

## üìã **DESCRIPCI√ìN**

Sistema completo de verificaci√≥n de cuentas por email con c√≥digo de 6 d√≠gitos que expira en 24 horas, implementado en Lumetrix basado en el sistema de MemoFlip.

---

## üóÑÔ∏è **1. ESTRUCTURA DE BASE DE DATOS (YA EXISTENTE)**

### **Columnas de verificaci√≥n en `usuarios_aplicaciones`:**

La tabla **YA TIENE** las columnas necesarias para verificaci√≥n:

```sql
-- COLUMNAS EXISTENTES (NO crear nuevas)
verification_code      VARCHAR(6)    -- C√≥digo de 6 d√≠gitos
verification_expiry    DATETIME      -- Fecha/hora de expiraci√≥n
verified_at           TIMESTAMP     -- Timestamp cuando se verific√≥
```

### **NO ES NECESARIO ejecutar ning√∫n SQL**
Las columnas ya existen en la tabla. Solo usar las existentes.

---

## üìß **2. SISTEMA DE ENV√çO DE EMAILS**

### **Archivo:** `PARA_HOSTALIA/sistema_apps_upload/lumetrix/enviar_email.php`

**Funciones principales:**

#### `enviarEmailVerificacion($email, $nombre, $codigo)`
- Env√≠a email HTML con el c√≥digo de verificaci√≥n
- Template bonito con gradientes y estilo Lumetrix
- Retorna `true` si el email se envi√≥ correctamente

#### `generarCodigoVerificacion()`
- Genera c√≥digo aleatorio de 6 d√≠gitos
- Formato: `123456`

#### `codigoEsValido($verification_expiry)`
- Verifica si un c√≥digo ha expirado
- Compara `verification_expiry` (datetime) con el timestamp actual

---

## üîê **3. API DE AUTENTICACI√ìN ACTUALIZADA**

### **Archivo:** `PARA_HOSTALIA/sistema_apps_upload/lumetrix/auth_con_verificacion.php`

### **Endpoints nuevos:**

#### `POST auth.php?action=register`
**Request:**
```json
{
  "action": "register",
  "email": "usuario@ejemplo.com",
  "nombre": "Juan P√©rez",
  "username": "juan123",
  "password": "contrase√±a123"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Registro exitoso. Revisa tu email para el c√≥digo de verificaci√≥n.",
  "email_sent": true,
  "requires_verification": true,
  "user_key": "usuario@ejemplo.com_lumetrix"
}
```

---

#### `POST auth.php?action=verify_code`
**Request:**
```json
{
  "action": "verify_code",
  "email": "usuario@ejemplo.com",
  "codigo": "123456"
}
```

**Response (√©xito):**
```json
{
  "success": true,
  "message": "¬°Cuenta verificada correctamente!",
  "verified": true,
  "user_key": "usuario@ejemplo.com_lumetrix"
}
```

**Response (error):**
```json
{
  "success": false,
  "error": "C√≥digo incorrecto"
}
```

---

#### `POST auth.php?action=resend_code`
**Request:**
```json
{
  "action": "resend_code",
  "email": "usuario@ejemplo.com"
}
```

**Response:**
```json
{
  "success": true,
  "message": "C√≥digo reenviado a tu email",
  "email_sent": true
}
```

---

#### `POST auth.php?action=login`
**MODIFICADO:** Ahora verifica que el email est√© verificado antes de permitir login.

**Response (no verificado):**
```json
{
  "success": false,
  "error": "Debes verificar tu email antes de iniciar sesi√≥n"
}
```

---

## üé® **4. COMPONENTES REACT**

### **Archivo:** `frontend/src/VerificationModal.jsx`

**Modal de verificaci√≥n** con:
- Input de 6 d√≠gitos num√©ricos
- Bot√≥n "Verificar c√≥digo"
- Bot√≥n "Reenviar c√≥digo"
- Contador de expiraci√≥n (24h)
- Mensajes de error/√©xito

**Props:**
```javascript
{
  isOpen: boolean,
  onClose: () => void,
  email: string,
  onVerificationSuccess: () => void
}
```

---

### **Archivo:** `frontend/src/AuthModal.jsx` (NUEVO)

**Modal de autenticaci√≥n completo** con:
- Tabs para Login/Registro
- Formulario de registro con verificaci√≥n
- Formulario de login
- Integraci√≥n con VerificationModal
- Manejo del flujo: Registro ‚Üí Verificaci√≥n ‚Üí Login

---

## üîÑ **5. FLUJO COMPLETO**

### **Registro:**
```
1. Usuario llena formulario de registro
   ‚Üì
2. Sistema genera c√≥digo de 6 d√≠gitos
   ‚Üì
3. Se guarda en BD (usuarios_aplicaciones)
   ‚Üì
4. Se env√≠a email con el c√≥digo
   ‚Üì
5. Usuario introduce el c√≥digo en la app
   ‚Üì
6. Sistema valida:
   - C√≥digo correcto ‚úÖ
   - No expirado (< 24h) ‚úÖ
   ‚Üì
7. Cuenta activada ‚Üí Puede hacer login
```

### **Login:**
```
1. Usuario introduce email + password
   ‚Üì
2. Sistema verifica:
   - Credenciales correctas ‚úÖ
   - Email verificado ‚úÖ
   ‚Üì
3. Si email NO verificado ‚Üí Error
4. Si todo OK ‚Üí Login exitoso
```

---

## üìä **6. ESTADOS DE USUARIO**

| Estado | `activo` | `verified_at` | `verification_code` | ¬øPuede login? |
|--------|----------|---------------|-------------------|---------------|
| **Reci√©n registrado** | 0 | NULL | 123456 | ‚ùå No |
| **Email verificado** | 1 | 2024-10-13 10:30:00 | NULL | ‚úÖ S√≠ |
| **Usuario antiguo** | 1 | 2024-01-01 00:00:00 | NULL | ‚úÖ S√≠ |

---

## üß™ **7. TESTING**

### **Prueba en desarrollo:**

1. **Registro:**
   ```
   Email: test@ejemplo.com
   Nombre: Usuario Test
   Username: test123
   Password: test123
   ```

2. **Verificar respuesta del servidor:**
   - Si `email_sent: false`, el c√≥digo aparecer√° en la respuesta
   - Si `email_sent: true`, revisar email (o spam)

3. **Introducir c√≥digo:**
   - C√≥digo: `123456` (6 d√≠gitos)
   - Verificar que cuenta se activa

4. **Intentar login:**
   - Antes de verificar ‚Üí Error
   - Despu√©s de verificar ‚Üí OK ‚úÖ

---

## üöÄ **8. DESPLIEGUE**

### **Pasos para activar en producci√≥n:**

1. **Subir archivos PHP:**
   ```
   PARA_HOSTALIA/sistema_apps_upload/lumetrix/
   ‚îú‚îÄ‚îÄ enviar_email.php (NUEVO)
   ‚îî‚îÄ‚îÄ auth_con_verificacion.php (reemplazar auth.php)
   ```

2. **Compilar y subir React:**
   ```bash
   cd frontend
   npm run build
   # Subir carpeta dist/ a Hostalia
   ```

3. **Verificar configuraci√≥n de email:**
   - Servidor SMTP configurado en Hostalia
   - Email `noreply@colisan.com` debe existir
   - Verificar que emails NO vayan a spam

---

## ‚öôÔ∏è **9. CONFIGURACI√ìN AVANZADA**

### **Cambiar tiempo de expiraci√≥n:**
```php
// En enviar_email.php, l√≠nea ~67
function codigoEsValido($tiempo_verificacion, $horas_validez = 24) {
    // Cambiar 24 por el n√∫mero de horas deseado
}
```

### **Cambiar longitud del c√≥digo:**
```php
// En enviar_email.php, l√≠nea ~58
function generarCodigoVerificacion() {
    return str_pad(rand(100000, 999999), 6, '0', STR_PAD_LEFT);
    // Para 4 d√≠gitos: rand(1000, 9999) y str_pad(..., 4, ...)
}
```

### **Personalizar email:**
Editar `enviar_email.php` l√≠nea 13-65 (HTML del email)

---

## üìß **10. PLANTILLA DE EMAIL**

El email enviado incluye:
- ‚úÖ Header con gradiente Lumetrix
- ‚úÖ C√≥digo destacado en grande
- ‚úÖ Instrucciones claras
- ‚úÖ Advertencia de expiraci√≥n
- ‚úÖ Dise√±o responsive
- ‚úÖ Mensaje de "no responder"

---

## üîç **11. TROUBLESHOOTING**

### **Email no se env√≠a:**
- Verificar configuraci√≥n SMTP en Hostalia
- Revisar logs: `error_log` en `enviar_email.php`
- Comprobar que el servidor permite `mail()`

### **C√≥digo no v√°lido:**
- Verificar que no hayan pasado 24 horas
- Comprobar que el c√≥digo es exactamente 6 d√≠gitos
- Revisar campo `verification_code` en BD

### **Usuario no puede hacer login:**
- Verificar campo `verified_at` NO es NULL
- Verificar campo `activo = 1`
- Comprobar que la contrase√±a sea correcta

---

## üìù **12. NOTAS IMPORTANTES**

‚ö†Ô∏è **Columnas usadas:**
El sistema usa las columnas EXISTENTES en la tabla:
- `verification_code` (varchar 6) - C√≥digo de 6 d√≠gitos
- `verification_expiry` (datetime) - Fecha/hora de expiraci√≥n
- `verified_at` (timestamp) - Cu√°ndo se verific√≥

‚ö†Ô∏è **Usuarios existentes:**
Los usuarios que ya estaban registrados tienen `verified_at` con una fecha, por lo que pueden hacer login sin problemas.

‚ö†Ô∏è **Seguridad:**
- Los c√≥digos se guardan en texto plano (no es cr√≠tico, solo son v√°lidos 24h)
- El c√≥digo expira autom√°ticamente seg√∫n `verification_expiry`
- Posible mejora futura: limitar intentos de verificaci√≥n

‚ö†Ô∏è **Modo desarrollo:**
Si el email falla al enviarse, el c√≥digo se devuelve en la respuesta JSON (solo para testing).

---

## ‚úÖ **13. CHECKLIST DE IMPLEMENTACI√ìN**

- [x] ‚úÖ Columnas existentes verificadas (`verification_code`, `verification_expiry`, `verified_at`)
- [x] ‚úÖ `enviar_email.php` creado y subido
- [x] ‚úÖ `auth_con_verificacion.php` creado
- [x] ‚úÖ `VerificationModal.jsx` creado
- [x] ‚úÖ `AuthModal.jsx` creado
- [x] ‚úÖ `App.jsx` actualizado con nuevos componentes
- [ ] üß™ Probar registro completo
- [ ] üß™ Verificar env√≠o de email
- [ ] üß™ Probar c√≥digo correcto
- [ ] üß™ Probar c√≥digo incorrecto
- [ ] üß™ Probar c√≥digo expirado
- [ ] üß™ Probar reenv√≠o de c√≥digo
- [ ] üß™ Verificar que login requiere verificaci√≥n

---

**¬°Sistema de verificaci√≥n por email implementado en Lumetrix!** üéâ

---

# üîß SOLUCI√ìN: Sincronizaci√≥n Offline en APK Capacitor

## ‚ùå **PROBLEMA DETECTADO**

### S√≠ntoma:
Cuando un usuario **juega offline** (sin internet):
1. ‚úÖ El progreso se guarda localmente en `localStorage`
2. ‚úÖ Se marca como pendiente de sincronizaci√≥n
3. ‚ùå Al reconectar y hacer auto-login, el progreso del **servidor** sobrescribe el **local**
4. ‚ùå **Se pierde el avance offline**

### Ejemplo:
```
1. Usuario en nivel 10 (servidor)
2. Quita internet
3. Juega offline: nivel 10 ‚Üí 15
4. Se guarda en localStorage: nivel 15 ‚úÖ
5. Conecta internet
6. Auto-login carga nivel 10 del servidor ‚ùå
7. PIERDE niveles 11-15 jugados offline ‚ùå
```

---

## üéØ **CAUSA DEL PROBLEMA**

En `handleLoginSuccess` (o funci√≥n similar de login), el c√≥digo:
1. Recibe datos del servidor (nivel 10)
2. Los aplica directamente al store
3. **NO compara** con el progreso local (nivel 15)
4. **Sobrescribe** el progreso m√°s avanzado

---

## ‚úÖ **SOLUCI√ìN: Merge Inteligente**

### Estrategia:
Al hacer login, **comparar** progreso servidor vs local y **usar el m√°s avanzado**.

---

## üìù **C√ìDIGO IMPLEMENTADO EN LUMETRIX**

### **Funci√≥n mergeProgress**:

```javascript
// üîÄ MERGE INTELIGENTE: Combinar progreso servidor + local
const mergeProgress = (userData) => {
  const localProgress = getLocalProgress();
  
  // Obtener datos del servidor
  const serverLevel = userData?.nivel_actual || 1;
  const serverTime = userData?.total_time_s || 0;
  const serverPuntos = userData?.total_puntos || 0;
  
  // üîÄ MERGE: Usar el progreso m√°s avanzado
  const finalLevel = Math.max(serverLevel, localProgress.nivel_actual);
  const finalTime = Math.max(serverTime, localProgress.total_time_s);
  const finalPuntos = Math.max(serverPuntos, localProgress.total_puntos);
  
  console.log('üìä Merge progreso:', { 
    servidor: { nivel: serverLevel, tiempo: serverTime, puntos: serverPuntos },
    local: { nivel: localProgress.nivel_actual, tiempo: localProgress.total_time_s, puntos: localProgress.total_puntos },
    final: { nivel: finalLevel, tiempo: finalTime, puntos: finalPuntos }
  });
  
  // ‚úÖ Aplicar el progreso m√°s avanzado
  setLevel(finalLevel);
  setCurrentLevel(finalLevel);
  setTotalTime(finalTime);
  setTotalPuntos(finalPuntos);
  
  // Guardar en localStorage
  saveLocalProgress(finalLevel, finalTime, finalPuntos);
  
  // üì§ Si el progreso local es mayor, sincronizar al servidor
  if (finalLevel > serverLevel || finalTime > serverTime || finalPuntos > serverPuntos) {
    console.log('üì§ Progreso local m√°s avanzado, sincronizando al servidor...');
    setTimeout(() => {
      syncToServer().then(() => {
        console.log('‚úÖ Progreso offline sincronizado al servidor');
      }).catch(err => {
        console.error('‚ùå Error sincronizando progreso:', err);
      });
    }, 500);
  }
};
```

### **Aplicado en:**
- `checkSession()` - Cuando detecta sesi√≥n activa
- `auto-login` - Cuando hace login autom√°tico con credenciales guardadas
- `handleLogin()` - Cuando el usuario hace login manual (v√≠a reload)

---

## üîç **PUNTOS CLAVE**

### 1. **Obtener progreso local**
```javascript
const localProgress = getLocalProgress();
```

### 2. **Comparar y usar el mayor**
```javascript
const finalLevel = Math.max(serverLevel, localProgress.nivel_actual);
const finalTime = Math.max(serverTime, localProgress.total_time_s);
const finalPuntos = Math.max(serverPuntos, localProgress.total_puntos);
```

### 3. **Sincronizar al servidor si local > servidor**
```javascript
if (finalLevel > serverLevel || finalTime > serverTime || finalPuntos > serverPuntos) {
  await syncToServer();
}
```

---

## üß™ **C√ìMO PROBAR**

### Escenario de prueba:
1. ‚úÖ Login con internet (ej: nivel 5)
2. ‚ùå Quitar internet (modo avi√≥n)
3. üéÆ Jugar 3 niveles (5 ‚Üí 8)
4. ‚úÖ Conectar internet
5. üîÑ Reabrir la app (o hacer logout/login)

### Resultado esperado:
```
üìä Merge progreso: {
  servidor: { nivel: 5, tiempo: 500, puntos: 5000 },
  local: { nivel: 8, tiempo: 800, puntos: 8000 },
  final: { nivel: 8, tiempo: 800, puntos: 8000 }
}
üì§ Progreso local m√°s avanzado, sincronizando al servidor...
‚úÖ Progreso offline sincronizado al servidor
```

**El usuario deber√≠a estar en nivel 8, NO en nivel 5** ‚úÖ

---

## üìÇ **ARCHIVOS MODIFICADOS EN LUMETRIX**

- `frontend/src/App.jsx` - Componente `Intro` con funci√≥n `mergeProgress`

---

## üéØ **BENEFICIOS**

‚úÖ **Sin p√©rdida de progreso offline**  
‚úÖ **Sincronizaci√≥n autom√°tica al reconectar**  
‚úÖ **Experiencia fluida para el usuario**  
‚úÖ **Logs claros para debugging**

---

## üìã **CHECKLIST DE IMPLEMENTACI√ìN**

- [x] ‚úÖ Modificar funci√≥n de login para obtener `getLocalProgress()`
- [x] ‚úÖ Implementar merge con `Math.max()`
- [x] ‚úÖ A√±adir sincronizaci√≥n condicional al servidor
- [x] ‚úÖ A√±adir logs de debugging
- [ ] üß™ Probar escenario offline ‚Üí online
- [ ] üß™ Verificar que progreso se mantiene
- [ ] üß™ Verificar que se sincroniza al servidor

---

**¬°Lumetrix ahora tiene el mismo fix que MemoFlip!** üöÄ